<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS AI Cost Calculator - Success Academies</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --sa-blue: #005e9e;
            --sa-orange: #f7941e;
            --sa-white: #ffffff;
            --sa-black: #000000;
            --sa-gray-light: #f5f5f5;
            --sa-gray-medium: #e0e0e0;
            --sa-gray-dark: #666666;
            --sa-green: #4caf50;
            --sa-red: #f44336;
            --sa-purple: #9c27b0;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 20px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', Arial, Helvetica, sans-serif;
            background-color: var(--sa-gray-light);
            color: var(--sa-black);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background-color: var(--sa-white);
            box-shadow: var(--shadow);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--sa-black);
            text-decoration: none;
        }

        .logo span {
            color: var(--sa-orange);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Cards */
        .card {
            background: var(--sa-white);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--sa-gray-light);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--sa-blue);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background-color: var(--sa-blue);
            color: var(--sa-white);
        }

        .btn-primary:hover {
            background-color: #004b7f;
        }

        .btn-secondary {
            background-color: var(--sa-orange);
            color: var(--sa-white);
        }

        .btn-secondary:hover {
            background-color: #e67e00;
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--sa-blue);
            color: var(--sa-blue);
        }

        .btn-outline:hover {
            background-color: var(--sa-blue);
            color: var(--sa-white);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--sa-gray-dark);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--sa-gray-medium);
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--sa-blue);
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3rem;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background-color: var(--sa-gray-medium);
            z-index: -1;
        }

        .step.completed:not(:last-child)::after {
            background-color: var(--sa-orange);
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--sa-gray-medium);
            color: var(--sa-white);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .step.active .step-number {
            background-color: var(--sa-blue);
        }

        .step.completed .step-number {
            background-color: var(--sa-orange);
        }

        .step-label {
            font-size: 0.875rem;
            color: var(--sa-gray-dark);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--sa-gray-medium);
            border-top-color: var(--sa-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: var(--sa-white);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 400px;
        }
        
        .loading-spinner-large {
            width: 50px;
            height: 50px;
            border: 5px solid var(--sa-gray-medium);
            border-top-color: var(--sa-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        .loading-text {
            font-size: 1.1rem;
            color: var(--sa-gray-dark);
            margin-bottom: 0.5rem;
        }
        
        .loading-details {
            font-size: 0.875rem;
            color: var(--sa-gray-dark);
            opacity: 0.8;
        }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: var(--sa-gray-medium);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 1rem;
        }
        
        .progress-bar-fill {
            height: 100%;
            background-color: var(--sa-orange);
            transition: width 0.3s ease;
        }
        
        /* Date preset buttons */
        .date-preset-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .date-preset-buttons .btn-outline {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .date-preset-buttons .btn-outline.active {
            background-color: var(--sa-blue);
            color: var(--sa-white);
        }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .alert-info {
            background-color: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .alert-success {
            background-color: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }

        .alert-error {
            background-color: #ffebee;
            color: #d32f2f;
            border-left: 4px solid #d32f2f;
        }

        /* Results Grid */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--sa-gray-light);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--sa-blue);
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: var(--sa-gray-dark);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Cost Table */
        .cost-table {
            width: 100%;
            border-collapse: collapse;
        }

        .cost-table th,
        .cost-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--sa-gray-medium);
        }

        .cost-table th {
            background-color: var(--sa-gray-light);
            font-weight: 600;
            color: var(--sa-gray-dark);
            text-transform: uppercase;
            font-size: 0.875rem;
        }

        .cost-table tr:hover {
            background-color: var(--sa-gray-light);
        }

        /* Account List */
        .account-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--sa-gray-medium);
            border-radius: 4px;
            padding: 1rem;
        }

        .account-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .account-item:hover {
            background-color: var(--sa-gray-light);
        }

        .account-item input[type="checkbox"] {
            margin-right: 1rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .account-info {
            flex: 1;
        }

        .account-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .account-id {
            font-size: 0.875rem;
            color: var(--sa-gray-dark);
        }

        /* Hidden by default */
        .hidden {
            display: none !important;
        }

        /* Charts Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 2rem;
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }
        
        /* AI Service Selection */
        #serviceSelection h4 {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .btn-secondary {
            background-color: var(--sa-gray-medium);
            color: var(--sa-black);
        }
        
        .btn-secondary:hover {
            background-color: var(--sa-gray-dark);
            color: var(--sa-white);
        }
        
        /* Stat Cards */
        .stat-card {
            background: var(--sa-gray-light);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--sa-gray-medium);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--sa-blue);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--sa-gray-dark);
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading-spinner-large"></div>
            <div class="loading-text" id="loadingText">Processing...</div>
            <div class="loading-details" id="loadingDetails"></div>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;"></div>
            </div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo">
                Success Academies <span>AI Cost Calculator</span>
            </a>
            <div id="authStatus">
                <span class="auth-status">Not Authenticated</span>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-label">Configure SSO</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-label">Select Accounts</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-label">Discover Resources</div>
            </div>
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div class="step-label">Calculate Costs</div>
            </div>
        </div>

        <!-- Step 1: SSO Configuration -->
        <div class="card" id="ssoConfig">
            <div class="card-header">
                <h2 class="card-title">AWS SSO Configuration</h2>
            </div>
            <div class="alert alert-info">
                Enter your AWS SSO URL to authenticate via Okta
            </div>
            <form id="ssoForm">
                <div class="form-group">
                    <label class="form-label" for="ssoUrl">SSO Start URL</label>
                    <input 
                        type="url" 
                        id="ssoUrl" 
                        class="form-input" 
                        placeholder="https://d-9067640efb.awsapps.com/start"
                        value="https://d-9067640efb.awsapps.com/start"
                        required
                    >
                </div>
                <div class="form-group">
                    <label class="form-label" for="ssoRegion">AWS Region</label>
                    <input 
                        type="text" 
                        id="ssoRegion" 
                        class="form-input" 
                        value="us-east-1"
                        required
                    >
                </div>
                <button type="submit" class="btn btn-primary">
                    Configure & Authenticate
                </button>
            </form>
        </div>

        <!-- Step 2: Account Selection -->
        <div class="card hidden" id="accountSelection">
            <div class="card-header">
                <h2 class="card-title">Select AWS Accounts</h2>
                <button class="btn btn-outline" id="selectAllBtn">Select All</button>
            </div>
            <div class="account-list" id="accountList">
                <!-- Accounts will be populated here -->
            </div>
            <div style="margin-top: 2rem;">
                <button class="btn btn-primary" id="continueToDiscovery">
                    Continue to Discovery
                </button>
            </div>
        </div>

        <!-- Step 3: Resource Discovery -->
        <div class="card hidden" id="resourceDiscovery">
            <div class="card-header">
                <h2 class="card-title">Configure Analysis Period</h2>
            </div>
            
            <!-- Date Selection -->
            <div id="dateSelection" style="margin-bottom: 2rem;">
                <div class="form-group">
                    <label class="form-label">Select Date Range</label>
                    <div class="date-preset-buttons">
                        <button class="btn btn-outline" onclick="setDatePreset('current')" data-preset="current">Current Month</button>
                        <button class="btn btn-outline" onclick="setDatePreset('last30')" data-preset="last30">Last 30 Days</button>
                        <button class="btn btn-outline" onclick="setDatePreset('last90')" data-preset="last90">Last 90 Days</button>
                        <button class="btn btn-outline" onclick="setDatePreset('lastMonth')" data-preset="lastMonth">Last Month</button>
                        <button class="btn btn-outline" onclick="setDatePreset('ytd')" data-preset="ytd">Year to Date</button>
                        <button class="btn btn-outline" onclick="setDatePreset('custom')" data-preset="custom">Custom Range</button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label" for="startDate">From Date</label>
                        <input type="date" id="startDate" class="form-input" required onchange="updateDatePresetButtons()">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="endDate">To Date</label>
                        <input type="date" id="endDate" class="form-input" required onchange="updateDatePresetButtons()">
                    </div>
                </div>
                
                <div style="margin-top: 1rem;">
                    <small class="text-muted" id="dateRangeInfo"></small>
                </div>
            </div>
            
            <!-- AI Service Selection -->
            <div id="serviceSelection" style="margin-bottom: 2rem;">
                <div class="form-group">
                    <label class="form-label">AWS AI/ML Services to Track</label>
                    <div class="alert alert-info">
                        The system automatically discovers and tracks costs for all enabled AI services. Select additional services to include.
                    </div>
                    
                    <!-- Select All / Clear All buttons -->
                    <div style="margin-bottom: 1rem;">
                        <button type="button" class="btn btn-small" onclick="selectAllAIServices()">Select All AI Services</button>
                        <button type="button" class="btn btn-small btn-secondary" onclick="clearAllAIServices()">Clear All</button>
                    </div>
                    
                    <!-- Foundation Models & Generative AI -->
                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--sa-blue);">Foundation Models & Generative AI</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-bedrock" value="bedrock" checked>
                            <span>Amazon Bedrock</span>
                        </label>
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-sagemaker" value="sagemaker" checked>
                            <span>Amazon SageMaker</span>
                        </label>
                    </div>
                    
                    <!-- Natural Language Processing -->
                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--sa-blue);">Natural Language Processing</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-comprehend" value="comprehend" checked>
                            <span>Amazon Comprehend</span>
                        </label>
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-translate" value="translate" checked>
                            <span>Amazon Translate</span>
                        </label>
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-textract" value="textract" checked>
                            <span>Amazon Textract</span>
                        </label>
                    </div>
                    
                    <!-- Computer Vision -->
                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--sa-blue);">Computer Vision</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-rekognition" value="rekognition" checked>
                            <span>Amazon Rekognition</span>
                        </label>
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-lookoutvision" value="lookoutvision">
                            <span>Amazon Lookout for Vision</span>
                        </label>
                    </div>
                    
                    <!-- Speech Services -->
                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--sa-blue);">Speech Services</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-polly" value="polly" checked>
                            <span>Amazon Polly</span>
                        </label>
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-transcribe" value="transcribe" checked>
                            <span>Amazon Transcribe</span>
                        </label>
                    </div>
                    
                    <!-- Conversational AI & Search -->
                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--sa-blue);">Conversational AI & Search</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-lex" value="lex" checked>
                            <span>Amazon Lex</span>
                        </label>
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-kendra" value="kendra" checked>
                            <span>Amazon Kendra</span>
                        </label>
                    </div>
                    
                    <!-- Forecasting & Personalization -->
                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--sa-blue);">Forecasting & Personalization</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-forecast" value="forecast" checked>
                            <span>Amazon Forecast</span>
                        </label>
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-personalize" value="personalize" checked>
                            <span>Amazon Personalize</span>
                        </label>
                    </div>
                    
                    <!-- Developer & Operations Tools -->
                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--sa-blue);">Developer & Operations Tools</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-codeguru" value="codeguru">
                            <span>Amazon CodeGuru</span>
                        </label>
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-devopsguru" value="devopsguru">
                            <span>Amazon DevOps Guru</span>
                        </label>
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-frauddetector" value="frauddetector">
                            <span>Amazon Fraud Detector</span>
                        </label>
                    </div>
                    
                    <!-- Specialized AI Services -->
                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--sa-blue);">Specialized AI Services</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-lookoutmetrics" value="lookoutmetrics">
                            <span>Lookout for Metrics</span>
                        </label>
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-lookoutequipment" value="lookoutequipment">
                            <span>Lookout for Equipment</span>
                        </label>
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-monitron" value="monitron">
                            <span>Amazon Monitron</span>
                        </label>
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-healthlake" value="healthlake">
                            <span>AWS HealthLake</span>
                        </label>
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-panorama" value="panorama">
                            <span>AWS Panorama</span>
                        </label>
                        <label class="account-item" style="margin: 0;">
                            <input type="checkbox" id="service-augmentedai" value="augmentedai">
                            <span>Amazon Augmented AI</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Account Filter (Failsafe) -->
            <div id="accountFilter" style="margin-bottom: 2rem;">
                <div class="form-group">
                    <label class="form-label">Account Filter (Failsafe)</label>
                    <div class="alert alert-info">
                        Only include resources from the selected account(s) to prevent including unrelated resources.
                    </div>
                    <select id="primaryAccountFilter" class="form-input">
                        <option value="all">All Selected Accounts</option>
                        <option value="sandbox">Sandbox Only</option>
                        <option value="nonprod">Non-Prod Only</option>
                        <option value="prod">Production Only</option>
                    </select>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="startDiscoveryWithDates()">
                Start Resource Discovery
            </button>
            
            <div id="discoveryProgress" class="hidden">
                <div class="alert alert-info">
                    <span class="spinner"></span>
                    <span style="margin-left: 1rem;">Scanning AWS accounts for AI services...</span>
                </div>
            </div>
            <div id="discoveryResults" class="hidden">
                <!-- Discovery results will be shown here -->
            </div>
        </div>

        <!-- Step 4: Cost Analysis -->
        <div class="card hidden" id="costAnalysis">
            <div class="card-header">
                <h2 class="card-title">AI Cost Analysis</h2>
                <div class="export-buttons">
                    <button class="btn btn-outline" onclick="exportResults('csv')">
                        <span style="margin-right: 0.5rem;">üìä</span> Export CSV
                    </button>
                    <button class="btn btn-outline" onclick="exportResults('json')">
                        <span style="margin-right: 0.5rem;">üìÑ</span> Export JSON
                    </button>
                    <button class="btn btn-primary" onclick="generateDetailedReport()">
                        <span style="margin-right: 0.5rem;">üìà</span> Generate Report
                    </button>
                </div>
            </div>
            
            <!-- Summary Metrics -->
            <div class="results-grid" id="summaryMetrics">
                <div class="metric-card">
                    <div class="metric-value" id="totalCost">$0.00</div>
                    <div class="metric-label">Total Monthly Cost</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="dailyAverage">$0.00</div>
                    <div class="metric-label">Daily Average</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="projectedCost">$0.00</div>
                    <div class="metric-label">Projected (57 Schools)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="resourceCount">0</div>
                    <div class="metric-label">AI Resources Found</div>
                </div>
            </div>

            <!-- Cost Breakdown Table -->
            <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--sa-blue);">Cost Breakdown by Service</h3>
            <table class="cost-table" id="costTable">
                <thead>
                    <tr>
                        <th>Account</th>
                        <th>Service</th>
                        <th>Monthly Cost</th>
                        <th>Project</th>
                    </tr>
                </thead>
                <tbody id="costTableBody">
                    <!-- Cost data will be populated here -->
                </tbody>
            </table>

            <!-- Project Breakdown -->
            <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--sa-blue);">Cost Breakdown by Project</h3>
            <div id="projectBreakdown" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <!-- Project cards will be populated here -->
            </div>

            <!-- AI-Powered Budget Analysis -->
            <div id="aiAnalysisSection" style="display: none;">
                <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--sa-blue);">
                    <span style="display: inline-flex; align-items: center;">
                        ü§ñ AI-Powered Budget Analysis
                        <button class="btn btn-primary btn-small" style="margin-left: 1rem;" onclick="runAIAnalysis()">
                            Refresh Analysis
                        </button>
                    </span>
                </h3>
                
                <!-- Executive Summary -->
                <div class="card" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); margin-bottom: 2rem;">
                    <h4 style="color: var(--sa-blue); margin-bottom: 1rem;">Executive Summary</h4>
                    <div id="executiveSummary" style="white-space: pre-wrap; line-height: 1.8;">
                        Loading AI insights...
                    </div>
                </div>
                
                <!-- Optimization Score -->
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="display: inline-block; position: relative;">
                        <svg width="200" height="200" viewBox="0 0 200 200">
                            <circle cx="100" cy="100" r="90" fill="none" stroke="#e0e0e0" stroke-width="20"/>
                            <circle id="scoreCircle" cx="100" cy="100" r="90" fill="none" stroke="var(--sa-green)" 
                                    stroke-width="20" stroke-linecap="round" transform="rotate(-90 100 100)"
                                    stroke-dasharray="565.48" stroke-dashoffset="565.48"/>
                            <text x="100" y="100" text-anchor="middle" dominant-baseline="middle">
                                <tspan id="scoreValue" style="font-size: 48px; font-weight: bold; fill: var(--sa-blue);">0</tspan>
                                <tspan x="100" y="130" style="font-size: 16px; fill: var(--sa-gray-dark);">Optimization Score</tspan>
                            </text>
                        </svg>
                    </div>
                </div>
                
                <!-- Key Insights -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div id="keyInsights">
                        <!-- Insights will be populated here -->
                    </div>
                </div>
                
                <!-- Recommendations Grid -->
                <h4 style="color: var(--sa-blue); margin: 2rem 0 1rem 0;">üí° Optimization Recommendations</h4>
                <div id="recommendationsGrid" style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                    <!-- Recommendations will be populated here -->
                </div>
                
                <!-- Savings Opportunities -->
                <h4 style="color: var(--sa-blue); margin: 2rem 0 1rem 0;">üí∞ Potential Savings</h4>
                <div id="savingsOpportunities" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <!-- Savings cards will be populated here -->
                </div>
                
                <!-- Implementation Roadmap -->
                <h4 style="color: var(--sa-blue); margin: 2rem 0 1rem 0;">üó∫Ô∏è Implementation Roadmap</h4>
                <div id="implementationRoadmap" style="margin-bottom: 2rem;">
                    <!-- Roadmap will be populated here -->
                </div>
                
                <!-- ROI Analysis -->
                <div class="card" style="background: #f0f9ff; border: 2px solid var(--sa-blue);">
                    <h4 style="color: var(--sa-blue); margin-bottom: 1rem;">üìä Return on Investment Analysis</h4>
                    <div id="roiAnalysis" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <!-- ROI metrics will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Chart Container -->
            <div class="chart-container">
                <canvas id="costChart"></canvas>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='accuracy_checker.js') }}"></script>
    <script>
        // Global state
        let currentStep = 1;
        let sessionId = null;
        let discoveryData = null;
        let costData = null;
        let selectedDates = {
            startDate: null,
            endDate: null
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthStatus();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('ssoForm').addEventListener('submit', handleSSOConfig);
            document.getElementById('selectAllBtn').addEventListener('click', selectAllAccounts);
            document.getElementById('continueToDiscovery').addEventListener('click', startDiscovery);
        }

        // Check authentication status
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/status', {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                
                if (data.authenticated) {
                    sessionId = data.session_id;
                    updateAuthStatus(true);
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
            }
        }

        // Update authentication status display
        function updateAuthStatus(authenticated) {
            const statusEl = document.querySelector('.auth-status');
            if (authenticated) {
                statusEl.textContent = 'Authenticated';
                statusEl.style.color = 'var(--sa-orange)';
            } else {
                statusEl.textContent = 'Not Authenticated';
                statusEl.style.color = 'var(--sa-gray-dark)';
            }
        }

        // Handle SSO configuration
        async function handleSSOConfig(e) {
            e.preventDefault();
            
            const ssoUrl = document.getElementById('ssoUrl').value;
            const ssoRegion = document.getElementById('ssoRegion').value;
            
            console.log('Starting SSO configuration with:', { ssoUrl, ssoRegion });
            showLoading('Configuring SSO...');
            
            try {
                // Configure SSO
                console.log('Sending configuration request...');
                const configResponse = await fetch('/api/auth/configure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sso_url: ssoUrl, sso_region: ssoRegion }),
                    credentials: 'same-origin'
                });
                
                console.log('Config response status:', configResponse.status);
                
                let configData;
                try {
                    configData = await configResponse.json();
                } catch (jsonError) {
                    console.error('Failed to parse config response:', jsonError);
                    throw new Error('Invalid response from server');
                }
                
                if (!configResponse.ok) {
                    console.error('Config failed:', configData);
                    throw new Error(configData.error || 'Configuration failed');
                }
                
                sessionId = configData.session_id;
                console.log('Session configured:', sessionId);
                
                // Start authentication
                showLoading('Starting authentication... A new browser window will open for SSO login.');
                
                console.log('Starting authentication...');
                const authResponse = await fetch('/api/auth/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });
                
                console.log('Auth response status:', authResponse.status);
                
                let authData;
                try {
                    authData = await authResponse.json();
                } catch (jsonError) {
                    console.error('Failed to parse auth response:', jsonError);
                    throw new Error('Invalid authentication response');
                }
                
                if (!authResponse.ok) {
                    console.error('Auth failed:', authData);
                    throw new Error(authData.error || 'Authentication failed');
                }
                
                console.log('Authentication started:', authData);
                
                // Show message about browser window
                showLoading('Please complete the login in the new browser window...');
                
                // Wait a bit for auth to complete
                setTimeout(async () => {
                    console.log('Checking authentication status...');
                    await loadAccounts();
                }, 5000);
                
            } catch (error) {
                console.error('Authentication error:', error);
                hideLoading();
                
                // Provide more helpful error messages
                if (error.message.includes('Failed to fetch')) {
                    showError('Network error: Unable to connect to the server. Please check if the server is running on http://localhost:5001');
                } else if (error.message.includes('NetworkError')) {
                    showError('Network error: Please check your internet connection and try again.');
                } else {
                    showError('Authentication failed: ' + error.message);
                }
            }
        }

        // Load AWS accounts
        async function loadAccounts() {
            try {
                const response = await fetch('/api/accounts/list', {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                
                if (!response.ok) throw new Error(data.error);
                
                displayAccounts(data.accounts);
                updateAuthStatus(true);
                moveToStep(2);
                hideLoading();
                
            } catch (error) {
                hideLoading();
                showError('Failed to load accounts: ' + error.message);
            }
        }

        // Display accounts for selection
        function displayAccounts(accounts) {
            const accountList = document.getElementById('accountList');
            accountList.innerHTML = '';
            
            accounts.forEach(account => {
                const accountItem = document.createElement('div');
                accountItem.className = 'account-item';
                accountItem.innerHTML = `
                    <input type="checkbox" id="account-${account.accountId}" value="${account.accountId}">
                    <div class="account-info">
                        <div class="account-name">${account.accountName || 'Unnamed Account'}</div>
                        <div class="account-id">${account.accountId}</div>
                    </div>
                `;
                accountList.appendChild(accountItem);
            });
        }

        // Select all accounts
        function selectAllAccounts() {
            const checkboxes = document.querySelectorAll('#accountList input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
            
            document.getElementById('selectAllBtn').textContent = allChecked ? 'Select All' : 'Deselect All';
        }
        
        // Select all AI services
        function selectAllAIServices() {
            const checkboxes = document.querySelectorAll('#serviceSelection input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
            });
        }
        
        // Clear all AI services
        function clearAllAIServices() {
            const checkboxes = document.querySelectorAll('#serviceSelection input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
        }

        // Set date preset values
        function setDatePreset(preset) {
            const today = new Date();
            let startDate, endDate;
            
            // Remove active class from all preset buttons
            document.querySelectorAll('.date-preset-buttons .btn-outline').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            const activeBtn = document.querySelector(`[data-preset="${preset}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            switch(preset) {
                case 'current':
                    // Current month
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = today;
                    break;
                case 'last30':
                    // Last 30 days
                    startDate = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
                    endDate = today;
                    break;
                case 'last90':
                    // Last 90 days
                    startDate = new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000));
                    endDate = today;
                    break;
                case 'lastMonth':
                    // Last month
                    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    startDate = lastMonth;
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0); // Last day of previous month
                    break;
                case 'ytd':
                    // Year to date
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = today;
                    break;
                case 'custom':
                    // Don't change dates for custom
                    updateDateRangeInfo();
                    return;
            }
            
            // Set the date inputs
            document.getElementById('startDate').value = formatDateForInput(startDate);
            document.getElementById('endDate').value = formatDateForInput(endDate);
            
            // Update date range info
            updateDateRangeInfo();
        }
        
        // Format date for HTML input
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Update date preset buttons based on selected dates
        function updateDatePresetButtons() {
            // Mark as custom if dates don't match any preset
            document.querySelectorAll('.date-preset-buttons .btn-outline').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('[data-preset="custom"]').classList.add('active');
            updateDateRangeInfo();
        }
        
        // Update date range info text
        function updateDateRangeInfo() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const infoEl = document.getElementById('dateRangeInfo');
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                infoEl.textContent = `Date range: ${days} day${days !== 1 ? 's' : ''} (${start.toLocaleDateString()} - ${end.toLocaleDateString()})`;
                infoEl.style.color = 'var(--sa-gray-dark)';
            } else {
                infoEl.textContent = 'Please select both start and end dates';
                infoEl.style.color = 'var(--sa-orange)';
            }
        }
        
        // Start resource discovery
        async function startDiscovery() {
            const selectedAccounts = Array.from(document.querySelectorAll('#accountList input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedAccounts.length === 0) {
                showError('Please select at least one account');
                return;
            }
            
            // Save selected accounts to backend
            try {
                showLoading('Saving account selection...');
                const response = await fetch('/api/accounts/select', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account_ids: selectedAccounts }),
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to save account selection');
                }
                
                console.log(`Selected ${data.selected_count} accounts`);
                hideLoading();
                
                moveToStep(3);
                
                // Initialize date selector
                initializeDateSelector();
            } catch (error) {
                hideLoading();
                showError('Failed to save account selection: ' + error.message);
            }
        }
        
        // Start discovery with selected dates
        async function startDiscoveryWithDates() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showError('Please select both start and end dates');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showError('Start date must be before end date');
                return;
            }
            
            // Get selected additional services
            const additionalServices = [];
            document.querySelectorAll('#serviceSelection input[type="checkbox"]:checked').forEach(cb => {
                additionalServices.push(cb.value);
            });
            
            // Get account filter
            const accountFilter = document.getElementById('primaryAccountFilter').value;
            
            // Store selected dates
            selectedDates.startDate = startDate;
            selectedDates.endDate = endDate;
            
            // Hide configuration sections, show progress
            document.getElementById('dateSelection').classList.add('hidden');
            document.getElementById('serviceSelection').classList.add('hidden');
            document.getElementById('accountFilter').classList.add('hidden');
            document.getElementById('discoveryProgress').classList.remove('hidden');
            
            try {
                showLoading('Discovering AI Resources', 'Scanning AWS accounts for AI services...', true);
                
                // Simulate progress updates
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    if (progress <= 90) {
                        updateProgress(progress);
                        
                        // Update details based on progress
                        if (progress === 20) updateLoadingDetails('Checking Lambda functions...');
                        if (progress === 40) updateLoadingDetails('Scanning S3 buckets and DynamoDB tables...');
                        if (progress === 60) updateLoadingDetails('Discovering Bedrock resources...');
                        if (progress === 80) updateLoadingDetails('Analyzing additional services...');
                    }
                }, 500);
                
                // Start discovery with dates and additional services
                const response = await fetch('/api/discover', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate,
                        additional_services: additionalServices,
                        account_filter: accountFilter
                    })
                });
                
                clearInterval(progressInterval);
                updateProgress(100);
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                
                discoveryData = data.discoveries;
                // Make discovery data globally accessible
                window.discoveryData = discoveryData;
                hideLoading();
                
                displayDiscoveryResults(data.discoveries);
                showSuccess(`Found ${data.discoveries.reduce((sum, d) => sum + d.summary.total_ai_resources, 0)} AI resources!`);
                
                // Automatically start cost calculation
                setTimeout(() => calculateCosts(), 1000);
                
            } catch (error) {
                hideLoading();
                showError('Discovery failed: ' + error.message);
                // Show configuration sections again on error
                document.getElementById('dateSelection').classList.remove('hidden');
                document.getElementById('serviceSelection').classList.remove('hidden');
                document.getElementById('accountFilter').classList.remove('hidden');
                document.getElementById('discoveryProgress').classList.add('hidden');
            }
        }

        // Display discovery results
        function displayDiscoveryResults(discoveries) {
            const resultsDiv = document.getElementById('discoveryResults');
            const progressDiv = document.getElementById('discoveryProgress');
            
            progressDiv.classList.add('hidden');
            resultsDiv.classList.remove('hidden');
            
            let totalResources = 0;
            let totalServices = new Set();
            let totalProjects = new Set();
            let serviceBreakdown = {};
            let projectBreakdown = {};
            
            // Aggregate data from all accounts
            discoveries.forEach(discovery => {
                totalResources += discovery.summary.total_ai_resources;
                
                // Aggregate services
                Object.keys(discovery.services || {}).forEach(service => {
                    totalServices.add(service);
                    if (!serviceBreakdown[service]) {
                        serviceBreakdown[service] = 0;
                    }
                    serviceBreakdown[service] += discovery.services[service].count || 0;
                });
                
                // Aggregate projects
                Object.keys(discovery.projects || {}).forEach(project => {
                    if (project !== 'Unknown') {
                        totalProjects.add(project);
                        if (!projectBreakdown[project]) {
                            projectBreakdown[project] = 0;
                        }
                        projectBreakdown[project] += discovery.projects[project].total_resources || 0;
                    }
                });
            });
            
            // Build HTML
            let html = '<h3>AI Resources Discovery Summary</h3>';
            
            // Overall stats
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 1rem 0;">';
            html += `<div class="stat-card">
                        <div class="stat-value">${totalResources}</div>
                        <div class="stat-label">Total AI Resources</div>
                     </div>`;
            html += `<div class="stat-card">
                        <div class="stat-value">${totalServices.size}</div>
                        <div class="stat-label">AI Services Found</div>
                     </div>`;
            html += `<div class="stat-card">
                        <div class="stat-value">${totalProjects.size}</div>
                        <div class="stat-label">Projects Identified</div>
                     </div>`;
            html += '</div>';
            
            // Service breakdown
            if (Object.keys(serviceBreakdown).length > 0) {
                html += '<h4 style="margin-top: 2rem;">Resources by Service:</h4>';
                html += '<ul>';
                Object.entries(serviceBreakdown)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([service, count]) => {
                        html += `<li><strong>${service}:</strong> ${count} resources</li>`;
                    });
                html += '</ul>';
            }
            
            // Project breakdown
            if (Object.keys(projectBreakdown).length > 0) {
                html += '<h4 style="margin-top: 2rem;">Resources by Project:</h4>';
                html += '<ul>';
                Object.entries(projectBreakdown)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([project, count]) => {
                        html += `<li><strong>${project}:</strong> ${count} resources</li>`;
                    });
                html += '</ul>';
            }
            
            resultsDiv.innerHTML = html;
        }

        // Calculate costs
        async function calculateCosts() {
            moveToStep(4);
            showLoading('Calculating AI Costs', 'Analyzing resource usage and calculating costs...', true);
            
            try {
                // Simulate progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 15;
                    if (progress <= 90) {
                        updateProgress(progress);
                        
                        if (progress === 15) updateLoadingDetails('Retrieving cost data from AWS Cost Explorer...');
                        if (progress === 30) updateLoadingDetails('Calculating Lambda function costs...');
                        if (progress === 45) updateLoadingDetails('Analyzing storage costs (S3, DynamoDB)...');
                        if (progress === 60) updateLoadingDetails('Processing AI service costs (Bedrock, etc.)...');
                        if (progress === 75) updateLoadingDetails('Aggregating costs by project and service...');
                    }
                }, 400);
                
                const response = await fetch('/api/costs/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start_date: selectedDates.startDate,
                        end_date: selectedDates.endDate
                    })
                });
                
                clearInterval(progressInterval);
                updateProgress(100);
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                
                costData = data;
                hideLoading();
                displayCostResults(data);
                
                // Show summary
                showSuccess(`Total AI costs: $${data.grand_total.toFixed(2)} for ${data.period}`);
                
                // Automatically run AI analysis
                setTimeout(() => {
                    runAIAnalysis();
                }, 1000);
                
            } catch (error) {
                hideLoading();
                showError('Cost calculation failed: ' + error.message);
            }
        }

        // Display cost results
        function displayCostResults(data) {
            // Update summary metrics
            document.getElementById('totalCost').textContent = `$${data.grand_total.toFixed(2)}`;
            document.getElementById('dailyAverage').textContent = `$${data.daily_average.toFixed(2)}`;
            document.getElementById('projectedCost').textContent = `$${data.projection_57_schools.toFixed(2)}`;
            
            // Count total resources
            let totalResources = 0;
            if (discoveryData) {
                discoveryData.forEach(d => {
                    totalResources += d.summary.total_ai_resources;
                });
            }
            document.getElementById('resourceCount').textContent = totalResources;
            
            // Ensure global discoveryData is available
            if (!window.discoveryData) {
                window.discoveryData = discoveryData || [];
            }
            
            // Add resource count to data for accuracy checker
            const enhancedData = {
                ...data,
                total_resources: totalResources,
                discovery_count: window.discoveryData.length,
                has_discovery_data: window.discoveryData.length > 0
            };
            
            // Log for debugging
            console.log('Cost data:', {
                grand_total: data.grand_total,
                total_resources: totalResources,
                discovery_data: window.discoveryData.length,
                costs_by_account: data.costs_by_account ? data.costs_by_account.length : 0
            });
            
            // Trigger accuracy checker if available
            if (window.accuracyChecker && window.accuracyChecker.checkAccuracy) {
                console.log('Running accuracy check on results...');
                window.accuracyChecker.checkAccuracy(enhancedData);
            }
            
            // Service name mapping for display
            const serviceDisplayNames = {
                'bedrock': 'Amazon Bedrock',
                'sagemaker': 'Amazon SageMaker',
                'comprehend': 'Amazon Comprehend',
                'textract': 'Amazon Textract',
                'rekognition': 'Amazon Rekognition',
                'polly': 'Amazon Polly',
                'transcribe': 'Amazon Transcribe',
                'translate': 'Amazon Translate',
                'forecast': 'Amazon Forecast',
                'personalize': 'Amazon Personalize',
                'lex': 'Amazon Lex',
                'kendra': 'Amazon Kendra',
                'lambda': 'AWS Lambda (AI)',
                's3': 'Amazon S3 (AI)',
                'dynamodb': 'Amazon DynamoDB (AI)'
            };
            
            // Known AI projects
            const knownAIProjects = [
                'Ask Eva', 
                'IEP Report', 
                'Resume Knockout', 
                'Resume Scoring', 
                'Financial Aid',
                'Parent App',
                'Sales Force',
                'Professional Development',
                'Unknown',
                'unattributed'
            ];
            
            // Populate cost table
            const tableBody = document.getElementById('costTableBody');
            tableBody.innerHTML = '';
            
            data.costs_by_account.forEach(accountCosts => {
                const accountName = accountCosts.account;
                
                // Filter to only show AI-related accounts (sandbox, non-prod, prod)
                const aiAccountKeywords = ['sandbox', 'non-prod', 'nonprod', 'prod', 'production'];
                const isAIAccount = aiAccountKeywords.some(keyword => 
                    accountName.toLowerCase().includes(keyword)
                );
                
                if (!isAIAccount) {
                    console.log(`Filtering out non-AI account: ${accountName}`);
                    return; // Skip non-AI accounts
                }
                
                // Add service costs
                Object.entries(accountCosts.services || {}).forEach(([service, cost]) => {
                    if (cost > 0) {
                        const displayName = serviceDisplayNames[service] || service.toUpperCase();
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>${accountName}</td>
                            <td>${displayName}</td>
                            <td>$${cost.toFixed(2)}</td>
                            <td>AI Services</td>
                        `;
                    }
                });
                
                // Add project costs - only show known AI projects
                Object.entries(accountCosts.projects || {}).forEach(([project, cost]) => {
                    if (cost > 0 && knownAIProjects.includes(project)) {
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>${accountName}</td>
                            <td>Multiple</td>
                            <td>$${cost.toFixed(2)}</td>
                            <td>${project}</td>
                        `;
                    }
                });
            });
            
            // If no rows were added, show a message
            if (tableBody.rows.length === 0) {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td colspan="4" style="text-align: center; color: var(--sa-gray-dark);">
                        No AI-related costs found for the selected period
                    </td>
                `;
            }
            
            // Create project breakdown
            createProjectBreakdown(data);
            
            // Create chart
            createCostChart(data);
        }
        
        // Create project breakdown cards
        function createProjectBreakdown(data) {
            const projectBreakdown = document.getElementById('projectBreakdown');
            projectBreakdown.innerHTML = '';
            
            // Use new project_breakdown structure from backend
            const projectCosts = {};
            const projectResources = {};
            
            // Check if we have the new project_breakdown structure
            if (data.project_breakdown) {
                Object.entries(data.project_breakdown).forEach(([projectName, projectData]) => {
                    projectCosts[projectName] = projectData.total_cost || 0;
                    projectResources[projectName] = projectData.resource_count || 0;
                });
            } else {
                // Fallback to old structure
                data.costs_by_account.forEach(accountCosts => {
                    // Process project costs
                    Object.entries(accountCosts.projects || {}).forEach(([project, cost]) => {
                        if (!projectCosts[project]) {
                            projectCosts[project] = 0;
                            projectResources[project] = 0;
                        }
                        projectCosts[project] += cost;
                    });
                });
                
                // Count resources by project from discovery data
                if (window.discoveryData && window.discoveryData[0]?.projects) {
                    Object.entries(window.discoveryData[0].projects).forEach(([projectKey, projectData]) => {
                        const projectName = projectData.name || projectKey;
                        if (!projectResources[projectName]) {
                            projectResources[projectName] = 0;
                        }
                        projectResources[projectName] = projectData.total_resources || 0;
                    });
                }
            }
            
            // Create cards for each project
            const projectOrder = [
                'Ask Eva',
                'IEP Report',
                'Financial Aid',
                'Resume Knockout',
                'Resume Scoring',
                'Parent App',
                'Sales Force Integration',
                'Professional Development',
                'AI Infrastructure',
                'Unattributed'
            ];
            
            projectOrder.forEach(projectName => {
                const cost = projectCosts[projectName] || 0;
                const resources = projectResources[projectName] || 0;
                
                // Only show projects with costs or resources
                if (cost > 0 || resources > 0) {
                    const card = document.createElement('div');
                    card.style.cssText = `
                        background: var(--sa-gray-light);
                        padding: 1.5rem;
                        border-radius: 8px;
                        border: 1px solid var(--sa-gray-medium);
                    `;
                    
                    const bgColor = projectName === 'unattributed' || projectName === 'Unknown' 
                        ? '#fee2e2' : '#e0f2fe';
                    
                    card.innerHTML = `
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--sa-blue);">${projectName}</h4>
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--sa-green);">
                            $${(typeof cost === 'number' ? cost : 0).toFixed(2)}
                        </div>
                        <div style="font-size: 0.9rem; color: var(--sa-gray-dark); margin-top: 0.5rem;">
                            ${resources} resources
                        </div>
                    `;
                    
                    projectBreakdown.appendChild(card);
                }
            });
            
            // If no projects found
            if (projectBreakdown.children.length === 0) {
                projectBreakdown.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; color: var(--sa-gray-dark);">
                        No project cost data available
                    </div>
                `;
            }
        }

        // Create cost chart
        function createCostChart(data) {
            const ctx = document.getElementById('costChart').getContext('2d');
            
            // Filter for AI accounts only
            const aiAccountKeywords = ['sandbox', 'non-prod', 'nonprod', 'prod', 'production'];
            
            // Aggregate costs by service (only from AI accounts)
            const serviceCosts = {};
            data.costs_by_account.forEach(accountCosts => {
                const accountName = accountCosts.account;
                const isAIAccount = aiAccountKeywords.some(keyword => 
                    accountName.toLowerCase().includes(keyword)
                );
                
                if (isAIAccount) {
                    Object.entries(accountCosts.services || {}).forEach(([service, cost]) => {
                        if (cost > 0) {
                            serviceCosts[service] = (serviceCosts[service] || 0) + cost;
                        }
                    });
                }
            });
            
            // Only create chart if there's data
            if (Object.keys(serviceCosts).length === 0) {
                document.getElementById('costChart').innerHTML = '<p style="text-align: center; color: var(--sa-gray-dark);">No cost data to display</p>';
                return;
            }
            
            // Get service display names
            const serviceDisplayNames = {
                'bedrock': 'Amazon Bedrock',
                'sagemaker': 'Amazon SageMaker',
                'comprehend': 'Amazon Comprehend',
                'textract': 'Amazon Textract',
                'rekognition': 'Amazon Rekognition',
                'polly': 'Amazon Polly',
                'transcribe': 'Amazon Transcribe',
                'translate': 'Amazon Translate',
                'forecast': 'Amazon Forecast',
                'personalize': 'Amazon Personalize',
                'lex': 'Amazon Lex',
                'kendra': 'Amazon Kendra',
                'lambda': 'AWS Lambda (AI)',
                's3': 'Amazon S3 (AI)',
                'dynamodb': 'Amazon DynamoDB (AI)'
            };
            
            const chartData = {
                labels: Object.keys(serviceCosts).map(s => serviceDisplayNames[s] || s.toUpperCase()),
                datasets: [{
                    label: 'Cost by Service',
                    data: Object.values(serviceCosts),
                    backgroundColor: [
                        '#005e9e',
                        '#f7941e',
                        '#4CAF50',
                        '#FF5252',
                        '#9C27B0',
                        '#00BCD4',
                        '#795548',
                        '#607D8B',
                        '#E91E63',
                        '#3F51B5'
                    ]
                }]
            };
            
            new Chart(ctx, {
                type: 'doughnut',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = '$' + context.parsed.toFixed(2);
                                    return label + ': ' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Export results
        async function exportResults(format) {
            try {
                showLoading('Preparing Export', `Generating ${format.toUpperCase()} file...`);
                
                const response = await fetch(`/api/export/${format}`);
                
                if (!response.ok) {
                    throw new Error('Export failed');
                }
                
                let filename = '';
                let blob;
                
                if (format === 'csv') {
                    blob = await response.blob();
                    filename = `ai_costs_detailed_${new Date().toISOString().split('T')[0]}.csv`;
                } else if (format === 'json') {
                    const data = await response.json();
                    // Add metadata to export
                    const exportData = {
                        export_date: new Date().toISOString(),
                        export_version: '1.0',
                        period: selectedDates,
                        summary: {
                            total_cost: data.grand_total,
                            daily_average: data.daily_average,
                            projection_57_schools: data.projection_57_schools,
                            total_resources: discoveryData ? discoveryData.reduce((sum, d) => sum + d.summary.total_ai_resources, 0) : 0
                        },
                        discoveries: discoveryData,
                        cost_details: data
                    };
                    blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    filename = `ai_costs_full_report_${new Date().toISOString().split('T')[0]}.json`;
                } else {
                    // Excel export
                    blob = await response.blob();
                    filename = `ai_costs_report_${new Date().toISOString().split('T')[0]}.xlsx`;
                }
                
                // Download file
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                hideLoading();
                showSuccess(`Export completed: ${filename}`);
                
            } catch (error) {
                hideLoading();
                showError('Export failed: ' + error.message);
            }
        }

        // UI Helper Functions
        function moveToStep(step) {
            // Hide all cards
            document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            
            // Show current step card
            const cards = ['ssoConfig', 'accountSelection', 'resourceDiscovery', 'costAnalysis'];
            document.getElementById(cards[step - 1]).classList.remove('hidden');
            
            // Update progress steps
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.classList.remove('active', 'completed');
                
                if (i < step) {
                    stepEl.classList.add('completed');
                } else if (i === step) {
                    stepEl.classList.add('active');
                }
            }
            
            currentStep = step;
        }

        function showLoading(message, details = '', showProgress = false) {
            const overlay = document.getElementById('loadingOverlay');
            const textEl = document.getElementById('loadingText');
            const detailsEl = document.getElementById('loadingDetails');
            const progressBar = document.getElementById('progressBar');
            
            overlay.classList.remove('hidden');
            textEl.textContent = message;
            detailsEl.textContent = details;
            
            if (showProgress) {
                progressBar.style.display = 'block';
                updateProgress(0);
            } else {
                progressBar.style.display = 'none';
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('hidden');
        }
        
        function updateProgress(percent) {
            const fill = document.getElementById('progressBarFill');
            fill.style.width = `${percent}%`;
        }
        
        function updateLoadingDetails(details) {
            const detailsEl = document.getElementById('loadingDetails');
            detailsEl.textContent = details;
        }

        function showError(message) {
            hideLoading();
            
            // Create a nice error alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-error';
            alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; max-width: 400px; z-index: 10000; animation: slideIn 0.3s ease;';
            alertDiv.innerHTML = `
                <strong>Error:</strong> ${message}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 1.2rem; cursor: pointer;">&times;</button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        function showSuccess(message) {
            hideLoading();
            
            // Create a nice success alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success';
            alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; max-width: 400px; z-index: 10000; animation: slideIn 0.3s ease;';
            alertDiv.innerHTML = `
                <strong>Success:</strong> ${message}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 1.2rem; cursor: pointer;">&times;</button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 3000);
        }
        
        // Generate detailed report
        function generateDetailedReport() {
            if (!costData || !discoveryData) {
                showError('Please complete cost calculation first');
                return;
            }
            
            showLoading('Generating Detailed Report', 'Creating comprehensive AI cost analysis report...');
            
            // Create detailed report HTML
            const reportWindow = window.open('', '_blank');
            const reportHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>AI Cost Analysis Report - Success Academies</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
                        h1 { color: #005e9e; border-bottom: 3px solid #f7941e; padding-bottom: 10px; }
                        h2 { color: #005e9e; margin-top: 30px; }
                        .summary { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
                        .metric { display: inline-block; margin: 10px 20px 10px 0; }
                        .metric-value { font-size: 24px; font-weight: bold; color: #005e9e; }
                        .metric-label { font-size: 14px; color: #666; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background: #005e9e; color: white; }
                        tr:hover { background: #f5f5f5; }
                        .project-section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
                        .footer { margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
                        @media print { body { margin: 20px; } }
                    </style>
                </head>
                <body>
                    <h1>AWS AI Cost Analysis Report</h1>
                    <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>Period:</strong> ${costData.period}</p>
                    
                    <div class="summary">
                        <h2>Executive Summary</h2>
                        <div class="metric">
                            <div class="metric-value">$${costData.grand_total.toFixed(2)}</div>
                            <div class="metric-label">Total AI Costs</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">$${costData.daily_average.toFixed(2)}</div>
                            <div class="metric-label">Daily Average</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">$${costData.projection_57_schools.toFixed(2)}</div>
                            <div class="metric-label">Projected (57 Schools)</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${discoveryData.reduce((sum, d) => sum + d.summary.total_ai_resources, 0)}</div>
                            <div class="metric-label">Total AI Resources</div>
                        </div>
                    </div>
                    
                    <h2>Cost Breakdown by Service</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Cost</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(costData.costs_by_account.reduce((acc, account) => {
                                Object.entries(account.services || {}).forEach(([service, cost]) => {
                                    acc[service] = (acc[service] || 0) + cost;
                                });
                                return acc;
                            }, {})).map(([service, cost]) => `
                                <tr>
                                    <td>${service.toUpperCase()}</td>
                                    <td>$${cost.toFixed(2)}</td>
                                    <td>${((cost / costData.grand_total) * 100).toFixed(1)}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <h2>AI Projects Summary</h2>
                    ${['Ask Eva', 'IEP Report', 'Resume Knockout', 'Resume Scoring', 'Financial Aid'].map(project => {
                        const projectCost = costData.costs_by_account.reduce((sum, account) => 
                            sum + (account.projects[project] || 0), 0);
                        const resources = discoveryData.flatMap(d => 
                            Object.values(d.services).flat()
                        ).filter(r => r.project === project);
                        
                        if (projectCost > 0 || resources.length > 0) {
                            return `
                                <div class="project-section">
                                    <h3>${project}</h3>
                                    <p><strong>Monthly Cost:</strong> $${projectCost.toFixed(2)}</p>
                                    <p><strong>Resources:</strong> ${resources.length}</p>
                                    <p><strong>Services Used:</strong> ${[...new Set(resources.map(r => r.service || 'Various'))].join(', ')}</p>
                                </div>
                            `;
                        }
                        return '';
                    }).join('')}
                    
                    <div class="footer">
                        <p>This report was generated by the Success Academies AI Cost Calculator</p>
                        <p>For questions or support, contact the IT department</p>
                    </div>
                </body>
                </html>
            `;
            
            reportWindow.document.write(reportHtml);
            reportWindow.document.close();
            
            hideLoading();
            showSuccess('Detailed report generated in new window');
        }
        
        // Initialize date selector on step 3
        function initializeDateSelector() {
            // Set default to current month
            setDatePreset('current');
        }
        
        // AI Analysis Functions
        async function runAIAnalysis() {
            if (!costData) {
                showError('Please calculate costs first before running AI analysis');
                return;
            }
            
            // Always show the AI analysis section
            document.getElementById('aiAnalysisSection').style.display = 'block';
            
            showLoading('Generating AI-powered insights...', 'Analyzing your AWS costs with advanced AI');
            
            try {
                const response = await fetch('/api/ai-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate AI analysis');
                }
                
                const analysisData = await response.json();
                displayAIAnalysis(analysisData);
                
                hideLoading();
                showSuccess('AI analysis completed successfully!');
                
                // Scroll to AI section
                document.getElementById('aiAnalysisSection').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                hideLoading();
                showError('AI analysis error: ' + error.message);
                console.error('AI analysis error:', error);
            }
        }
        
        function displayAIAnalysis(data) {
            console.log('AI Analysis Data received:', data);
            
            const aiAnalysis = data.ai_analysis || {};
            const optimizationPlan = data.optimization_plan || {};
            
            console.log('Savings opportunities:', aiAnalysis.savings_opportunities);
            console.log('Implementation roadmap:', optimizationPlan.implementation_roadmap);
            
            // Display Executive Summary
            document.getElementById('executiveSummary').textContent = 
                aiAnalysis.executive_summary || 'No executive summary available';
            
            // Display Optimization Score
            const score = aiAnalysis.optimization_score || 0;
            animateScore(score);
            
            // Display Key Insights
            displayKeyInsights(aiAnalysis.insights || []);
            
            // Display Recommendations
            displayRecommendations(aiAnalysis.recommendations || []);
            
            // Display Savings Opportunities
            displaySavingsOpportunities(aiAnalysis.savings_opportunities || {});
            
            // Display Implementation Roadmap
            displayImplementationRoadmap(optimizationPlan.implementation_roadmap || []);
            
            // Display ROI Analysis
            displayROIAnalysis(optimizationPlan.roi_analysis || {});
        }
        
        function animateScore(targetScore) {
            const scoreCircle = document.getElementById('scoreCircle');
            const scoreValue = document.getElementById('scoreValue');
            const circumference = 2 * Math.PI * 90;
            const offset = circumference - (targetScore / 100) * circumference;
            
            let currentScore = 0;
            const duration = 2000; // 2 seconds
            const increment = targetScore / (duration / 16); // 60fps
            
            const animate = () => {
                currentScore = Math.min(currentScore + increment, targetScore);
                scoreValue.textContent = Math.round(currentScore);
                
                const currentOffset = circumference - (currentScore / 100) * circumference;
                scoreCircle.style.strokeDashoffset = currentOffset;
                
                // Change color based on score
                if (currentScore < 40) {
                    scoreCircle.style.stroke = 'var(--sa-red)';
                } else if (currentScore < 70) {
                    scoreCircle.style.stroke = 'var(--sa-orange)';
                } else {
                    scoreCircle.style.stroke = 'var(--sa-green)';
                }
                
                if (currentScore < targetScore) {
                    requestAnimationFrame(animate);
                }
            };
            
            animate();
        }
        
        function displayKeyInsights(insights) {
            const container = document.getElementById('keyInsights');
            container.innerHTML = '';
            
            insights.forEach(insight => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cssText = `
                    background: ${getInsightColor(insight.impact)};
                    border-left: 4px solid ${getInsightBorderColor(insight.impact)};
                `;
                
                card.innerHTML = `
                    <h5 style="color: var(--sa-blue); margin-bottom: 0.5rem;">
                        ${getInsightIcon(insight.category)} ${insight.title}
                    </h5>
                    <p style="color: var(--sa-gray-dark); margin: 0;">
                        ${insight.description}
                    </p>
                `;
                
                container.appendChild(card);
            });
        }
        
        function displayRecommendations(recommendations) {
            const container = document.getElementById('recommendationsGrid');
            container.innerHTML = '';
            
            recommendations.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cssText = `
                    border-left: 4px solid ${getPriorityColor(rec.priority)};
                    transition: transform 0.3s ease;
                `;
                
                card.onmouseover = () => card.style.transform = 'translateY(-2px)';
                card.onmouseout = () => card.style.transform = 'translateY(0)';
                
                const implementationSteps = rec.implementation ? 
                    rec.implementation.map((step, idx) => `<li>${step}</li>`).join('') : '';
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <h5 style="color: var(--sa-blue); margin: 0;">${rec.title}</h5>
                        <span class="badge" style="background: ${getPriorityColor(rec.priority)}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">
                            ${rec.priority.toUpperCase()}
                        </span>
                    </div>
                    <p style="color: var(--sa-gray-dark); margin-bottom: 1rem;">${rec.description}</p>
                    ${rec.potential_savings ? `
                        <div style="font-size: 1.25rem; font-weight: bold; color: var(--sa-green); margin-bottom: 1rem;">
                            Potential Savings: ${rec.potential_savings}
                        </div>
                    ` : ''}
                    ${implementationSteps ? `
                        <details>
                            <summary style="cursor: pointer; color: var(--sa-blue);">Implementation Steps</summary>
                            <ol style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                ${implementationSteps}
                            </ol>
                        </details>
                    ` : ''}
                `;
                
                container.appendChild(card);
            });
        }
        
        function displaySavingsOpportunities(savings) {
            const container = document.getElementById('savingsOpportunities');
            container.innerHTML = '';
            
            console.log('Displaying savings opportunities:', savings);
            
            if (savings.total_potential_savings) {
                // Total savings card
                const totalCard = document.createElement('div');
                totalCard.className = 'card';
                totalCard.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;';
                totalCard.innerHTML = `
                    <h5 style="margin-bottom: 0.5rem;">Total Potential Savings</h5>
                    <div style="font-size: 2rem; font-weight: bold;">
                        $${savings.total_potential_savings.toFixed(2)}/month
                    </div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">
                        ${savings.savings_percentage?.toFixed(1)}% of current costs
                    </div>
                `;
                container.appendChild(totalCard);
            }
            
            // Individual opportunities
            (savings.opportunities || []).forEach(opp => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h5 style="color: var(--sa-blue); margin-bottom: 0.5rem;">${opp.name}</h5>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--sa-green);">
                        $${opp.monthly_savings.toFixed(2)}/month
                    </div>
                    <div style="color: var(--sa-gray-dark); font-size: 0.875rem;">
                        Effort: ${opp.effort} | Timeline: ${opp.timeline}
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function displayImplementationRoadmap(roadmap) {
            const container = document.getElementById('implementationRoadmap');
            container.innerHTML = '';
            
            console.log('Displaying implementation roadmap:', roadmap);
            
            if (!roadmap || roadmap.length === 0) {
                container.innerHTML = '<p style="color: var(--sa-gray-dark);">No implementation roadmap available.</p>';
                return;
            }
            
            roadmap.forEach((phase, index) => {
                const phaseDiv = document.createElement('div');
                phaseDiv.className = 'card';
                phaseDiv.style.cssText = 'margin-bottom: 1rem; position: relative; padding-left: 3rem;';
                
                // Phase number
                const phaseNumber = document.createElement('div');
                phaseNumber.style.cssText = `
                    position: absolute;
                    left: 1rem;
                    top: 1.5rem;
                    width: 30px;
                    height: 30px;
                    background: var(--sa-blue);
                    color: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                `;
                phaseNumber.textContent = index + 1;
                
                phaseDiv.innerHTML = `
                    <h5 style="color: var(--sa-blue); margin-bottom: 0.5rem;">${phase.phase}</h5>
                    <div style="margin-bottom: 0.5rem;">
                        <strong>Estimated Savings:</strong> $${phase.estimated_savings.toFixed(2)}/month
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <strong>Effort Level:</strong> ${phase.effort}
                    </div>
                    <div>
                        <strong>Key Actions:</strong>
                        <ul style="margin-top: 0.25rem; margin-bottom: 0;">
                            ${phase.actions.map(action => `<li>${action}</li>`).join('')}
                        </ul>
                    </div>
                `;
                
                phaseDiv.insertBefore(phaseNumber, phaseDiv.firstChild);
                container.appendChild(phaseDiv);
            });
        }
        
        function displayROIAnalysis(roi) {
            const container = document.getElementById('roiAnalysis');
            container.innerHTML = '';
            
            const metrics = [
                { label: 'Monthly Savings', value: `$${(roi.monthly_savings || 0).toFixed(2)}`, icon: 'üí∞' },
                { label: 'Annual Savings', value: `$${(roi.annual_savings || 0).toFixed(2)}`, icon: 'üìà' },
                { label: 'Implementation Cost', value: `$${(roi.implementation_cost || 0).toFixed(2)}`, icon: 'üí∏' },
                { label: 'Payback Period', value: `${roi.payback_period_days || 0} days`, icon: '‚è±Ô∏è' },
                { label: 'First Year Net', value: `$${(roi.first_year_net_savings || 0).toFixed(2)}`, icon: 'üéØ' },
                { label: 'Savings %', value: `${(roi.savings_percentage || 0).toFixed(1)}%`, icon: 'üìä' }
            ];
            
            metrics.forEach(metric => {
                const div = document.createElement('div');
                div.style.cssText = 'text-align: center;';
                div.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">${metric.icon}</div>
                    <div style="font-size: 1.25rem; font-weight: bold; color: var(--sa-blue);">
                        ${metric.value}
                    </div>
                    <div style="font-size: 0.875rem; color: var(--sa-gray-dark);">
                        ${metric.label}
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Helper functions for AI display
        function getInsightColor(impact) {
            const colors = {
                high: '#fee2e2',
                medium: '#fef3c7',
                low: '#dbeafe'
            };
            return colors[impact] || '#f5f5f5';
        }
        
        function getInsightBorderColor(impact) {
            const colors = {
                high: 'var(--sa-red)',
                medium: 'var(--sa-orange)',
                low: 'var(--sa-blue)'
            };
            return colors[impact] || 'var(--sa-gray-medium)';
        }
        
        function getInsightIcon(category) {
            const icons = {
                cost: 'üí∞',
                efficiency: '‚ö°',
                optimization: 'üéØ',
                risk: '‚ö†Ô∏è'
            };
            return icons[category] || 'üìä';
        }
        
        function getPriorityColor(priority) {
            const colors = {
                critical: 'var(--sa-red)',
                high: 'var(--sa-orange)',
                medium: 'var(--sa-blue)',
                low: 'var(--sa-gray-dark)'
            };
            return colors[priority] || 'var(--sa-gray-medium)';
        }
    </script>
</body>
</html>